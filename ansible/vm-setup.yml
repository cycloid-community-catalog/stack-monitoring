---
  - name: Update apt cache (equivalent to apt-get update)
    apt:
      update_cache: yes

    # Install exporters
  - name: Install Blackbox exporter
    include_role:
      name: prometheus.prometheus.blackbox_exporter
    tags: blackbox_exporter
    when: blackbox_exporter_install

  - name: Install MYSQL exporter
    include_role:
      name: prometheus.prometheus.mysqld_exporter
    tags: mysqld_exporter
    when: mysqld_exporter_install

  - name: Install PostgreSQL exporter
    include_role:
      name: prometheus.prometheus.postgres_exporter
    tags: postgres_exporter
    when: postgres_exporter_install

  - name: Install Node exporter
    include_role:
      name: prometheus.prometheus.node_exporter
    tags: node_exporter
    when: node_exporter_install

  # Install Prometheus
  - name: "Create custom alert rule file"
    template:
      src: templates/organization.rules
      dest: "{{ prometheus_config_dir }}/rules/{{organization}}.rules"
    when: prometheus_install | bool and prometheus_custom_rules != ""
    tags: prometheus

  - name: Install Prometheus
    include_role:
      name: prometheus.prometheus.prometheus
    tags: prometheus
    when: prometheus_install

  # Install Alertmanager
  - name: Install Alertmanager
    include_role:
      name: prometheus.prometheus.alertmanager
    tags: alertmanager
    when: alertmanager_install

 # Install Grafana
  - name: Install Grafana
    include_role:
      name: grafana.grafana.grafana
    when: grafana_install
    tags: grafana

  - name: Copy stack grafana dashboards JSON files to the target directory
    copy:
      src: "{{ item }}"
      dest: "{{ grafana_data_dir }}/{{ grafana_dashboards_dir }}"
      mode: '0644'
    with_fileglob:
      - "{{ grafana_dashboards_files}}"
    when: grafana_install
    tags: grafana

  # Install NGINX
  # Install SSL certificates for nginx
  - name: "Create SSL directory"
    file:
      path: "{{ certificates_dest }}"
      state: directory
    when: enable_tls | bool
    tags: nginx

  - name: "Install SSL certificates"
    copy:
      content: "{{ item }}"
      dest: "{{ certificates_dest }}"
      mode: 0600
    with_fileglob:
      - "{{nginx_cert}}"
      - "{{nginx_cert_key}}"
    when: enable_tls | bool
    tags: nginx

  - name: Install NGINX
    include_role:
      name: jdauphant.nginx
    tags: nginx